"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ Time-Travel –≤ LangGraph

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥—Ä–∞—Ñ –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
2. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—á–µ–∫–ø–æ–∏–Ω—Ç—ã)
3. "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏" –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
4. –ò–∑–º–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –ø—É—Ç–∏
"""
import uuid
from typing_extensions import TypedDict, NotRequired

from langgraph.graph import StateGraph, START, END
from langgraph.checkpoint.memory import InMemorySaver

from setup_llm import anthropic_llm

# ============================================================================
# 1. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –ò –ì–†–ê–§–ê
# ============================================================================

class State(TypedDict):
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—à–µ–≥–æ –≥—Ä–∞—Ñ–∞"""
    topic: NotRequired[str]  # –¢–µ–º–∞ –¥–ª—è —à—É—Ç–∫–∏
    joke: NotRequired[str]  # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à—É—Ç–∫–∞




def generate_topic(state: State):
    """–£–∑–µ–ª: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–º—ã –¥–ª—è —à—É—Ç–∫–∏"""
    print("üéØ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ–º—É –¥–ª—è —à—É—Ç–∫–∏...")
    msg = anthropic_llm.invoke("Give me a funny topic for a joke (just the topic, one sentence), use russian language for response")
    topic = msg.content
    print(f"   –¢–µ–º–∞: {topic}")
    return {"topic": topic}


def write_joke(state: State):
    """–£–∑–µ–ª: –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —à—É—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã"""
    print(f"‚úçÔ∏è  –ü–∏—à—É —à—É—Ç–∫—É –Ω–∞ —Ç–µ–º—É: {state['topic']}")
    msg = anthropic_llm.invoke(f"Write a short joke about {state['topic']}, use russian language for response")
    joke = msg.content
    print(f"   –®—É—Ç–∫–∞: {joke}")
    return {"joke": joke}


# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∞
workflow = StateGraph(State)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–∑–ª–æ–≤
workflow.add_node("generate_topic", generate_topic)
workflow.add_node("write_joke", write_joke)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π
workflow.add_edge(START, "generate_topic")
workflow.add_edge("generate_topic", "write_joke")
workflow.add_edge("write_joke", END)

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å —á–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä–æ–º (–Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è time-travel)
checkpointer = InMemorySaver()
graph = workflow.compile(checkpointer=checkpointer)

# ============================================================================
# 3. –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö –ì–†–ê–§–ê
# ============================================================================

print("\n" + "=" * 70)
print("–®–ê–ì 1: –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö")
print("=" * 70 + "\n")

# –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π thread_id –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
thread_id = str(uuid.uuid4())
config = {
    "configurable": {
        "thread_id": thread_id,
    }
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –≥—Ä–∞—Ñ
initial_state = graph.invoke({}, config)

print("\nüìã –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:")
print(f"   –¢–µ–º–∞: {initial_state['topic']}")
print(f"   –®—É—Ç–∫–∞: {initial_state['joke']}")

# ============================================================================
# 4. –ü–†–û–°–ú–û–¢–† –ò–°–¢–û–†–ò–ò –ß–ï–ö–ü–û–ò–ù–¢–û–í
# ============================================================================

print("\n" + "=" * 70)
print("–®–ê–ì 2: –ü–†–û–°–ú–û–¢–† –ò–°–¢–û–†–ò–ò –ß–ï–ö–ü–û–ò–ù–¢–û–í")
print("=" * 70 + "\n")

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã (–≤ –æ–±—Ä–∞—Ç–Ω–æ–º —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ)
states = list(graph.get_state_history(config))

print(f"–ù–∞–π–¥–µ–Ω–æ {len(states)} —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤:\n")

for i, state in enumerate(states):
    checkpoint_id = state.config["configurable"]["checkpoint_id"]
    next_nodes = state.next
    values = state.values

    print(f"–ß–µ–∫–ø–æ–∏–Ω—Ç #{i}:")
    print(f"  üìç ID: {checkpoint_id[:20]}...")
    print(f"  ‚û°Ô∏è  –°–ª–µ–¥—É—é—â–∏–µ —É–∑–ª—ã: {next_nodes}")
    print(f"  üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: {values}")
    print()

# ============================================================================
# 5. TIME-TRAVEL: –í–û–ó–í–†–ê–¢ –ö –ü–†–ï–î–´–î–£–©–ï–ú–£ –°–û–°–¢–û–Ø–ù–ò–Æ
# ============================================================================

print("=" * 70)
print("–®–ê–ì 3: TIME-TRAVEL - –í–û–ó–í–†–ê–¢ –ò –ò–ó–ú–ï–ù–ï–ù–ò–ï")
print("=" * 70 + "\n")

# –í—ã–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–º—ã, –Ω–æ –î–û –Ω–∞–ø–∏—Å–∞–Ω–∏—è —à—É—Ç–∫–∏
# –≠—Ç–æ states[1], —Ç–∞–∫ –∫–∞–∫ states[0] - —ç—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
target_state = states[1]

print(f"üïê –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —á–µ–∫–ø–æ–∏–Ω—Ç—É:")
print(f"   –°–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {target_state.next}")
print(f"   –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞: {target_state.values.get('topic', 'N/A')}")
print()

# –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–º—É –Ω–∞ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ
new_topic = "—Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ —Ñ–∏–ª—å–º—ã"
print(f"‚úèÔ∏è  –ú–µ–Ω—è–µ–º —Ç–µ–º—É –Ω–∞: '{new_topic}'")

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —ç—Ç–æ–º —á–µ–∫–ø–æ–∏–Ω—Ç–µ
new_config = graph.update_state(
    target_state.config,
    values={"topic": new_topic}
)

print(f"   –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–µ–∫–ø–æ–∏–Ω—Ç: {new_config['configurable']['checkpoint_id'][:20]}...")

# ============================================================================
# 6. –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –í–´–ü–û–õ–ù–ï–ù–ò–Ø –° –ù–û–í–û–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø
# ============================================================================

print("\n" + "=" * 70)
print("–®–ê–ì 4: –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –í–´–ü–û–õ–ù–ï–ù–ò–Ø")
print("=" * 70 + "\n")

print("üöÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...\n")

# –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å None –≤ –∫–∞—á–µ—Å—Ç–≤–µ –≤—Ö–æ–¥–∞
# –ì—Ä–∞—Ñ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
new_state = graph.invoke(None, new_config)

print("\nüìã –ù–æ–≤–æ–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:")
print(f"   –¢–µ–º–∞: {new_state['topic']}")
print(f"   –®—É—Ç–∫–∞: {new_state['joke']}")

# ============================================================================
# 7. –°–†–ê–í–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# ============================================================================

print("\n" + "=" * 70)
print("–°–†–ê–í–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í")
print("=" * 70 + "\n")

print("üîµ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è:")
print(f"   –¢–µ–º–∞: {initial_state['topic']}")
print(f"   –®—É—Ç–∫–∞: {initial_state['joke']}")
print()

print("üü¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è (–ø–æ—Å–ª–µ time-travel):")
print(f"   –¢–µ–º–∞: {new_state['topic']}")
print(f"   –®—É—Ç–∫–∞: {new_state['joke']}")
print()

print("=" * 70)
print("‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
print("=" * 70)

# ============================================================================
# 8. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û: –ü–†–û–°–ú–û–¢–† –û–ë–ù–û–í–õ–ï–ù–ù–û–ô –ò–°–¢–û–†–ò–ò
# ============================================================================

print("\n" + "=" * 70)
print("–ë–û–ù–£–°: –ò–°–¢–û–†–ò–Ø –ü–û–°–õ–ï TIME-TRAVEL")
print("=" * 70 + "\n")

# –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
updated_states = list(graph.get_state_history(config))

print(f"–¢–µ–ø–µ—Ä—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ {len(updated_states)} —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤")
print("(–≤–∫–ª—é—á–∞—è –Ω–æ–≤—É—é –≤–µ—Ç–∫—É –ø–æ—Å–ª–µ time-travel)\n")

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–º—ã –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
for i, state in enumerate(updated_states):
    topic = state.values.get('topic', 'N/A')
    if topic == 'N/A':
        print(state)
    joke_exists = 'joke' in state.values
    print(f"  {i}. –¢–µ–º–∞: {topic[:50]}... | –®—É—Ç–∫–∞: {'‚úì' if joke_exists else '‚úó'}")